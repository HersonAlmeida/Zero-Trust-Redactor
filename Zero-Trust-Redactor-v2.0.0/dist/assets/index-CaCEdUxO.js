import{_ as N,a as me,b as X,c as pe}from"./pdf-tools-DOT94L9g.js";(function(){const n=document.createElement("link").relList;if(n&&n.supports&&n.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))t(a);new MutationObserver(a=>{for(const s of a)if(s.type==="childList")for(const i of s.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&t(i)}).observe(document,{childList:!0,subtree:!0});function o(a){const s={};return a.integrity&&(s.integrity=a.integrity),a.referrerPolicy&&(s.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?s.credentials="include":a.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function t(a){if(a.ep)return;a.ep=!0;const s=o(a);fetch(a.href,s)}})();try{const e=await N(()=>import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0"),[],import.meta.url);console.log("üì¶ Using @huggingface/transformers v3");const{pipeline:n,env:o}=e;o.allowLocalModels=!1,o.allowRemoteModels=!0,o.useBrowserCache=!0,console.log("üîß Transformers env:",{allowLocalModels:o.allowLocalModels,allowRemoteModels:o.allowRemoteModels}),window.TransformersJS={pipeline:n,env:o,...e},console.log("‚úÖ Transformers.js loaded from CDN"),console.log("üìç Models will load from: Hugging Face CDN"),window.dispatchEvent(new Event("transformers-ready"))}catch(e){console.error("‚ùå Failed to load Transformers.js:",e),window.TransformersJSError=e,window.dispatchEvent(new Event("transformers-error"))}let x=null,C=null,$=!1,Y={bert:null,llama:null},D="standard",F=null;const h=(...e)=>{},H={standard:{name:"BERT Base NER",model:"Xenova/bert-base-NER",description:"Fast & Efficient",minRAM:2,quantized:!0},pro:{name:"BERT Base NER (Full Precision)",model:"Xenova/bert-base-NER",description:"Enhanced Accuracy",minRAM:6,quantized:!1}};async function Q(){if(F)return F;const e={ram:4,cores:navigator.hardwareConcurrency||4,gpu:!1,webgpu:!1,canUpgrade:!1,recommendation:"standard"};if(navigator.deviceMemory&&(e.ram=navigator.deviceMemory),navigator.gpu)try{const n=await navigator.gpu.requestAdapter();if(n){e.gpu=!0,e.webgpu=!0;const o=await n.requestAdapterInfo?.();o&&(e.gpuVendor=o.vendor,e.gpuDevice=o.device)}}catch(n){h("WebGPU not available:",n.message)}return e.ram>=8&&e.cores>=4?(e.canUpgrade=!0,e.recommendation="pro"):e.ram>=6&&e.cores>=4&&(e.canUpgrade=!0,e.recommendation="standard"),F=e,e}function fe(){return{tier:D,config:H[D],canUpgrade:F?.canUpgrade||!1}}async function ge(){return(await Q()).canUpgrade}async function we(){const e=["transformers-cache","onnx-cache","webllm"];for(const n of e)try{await new Promise((o,t)=>{const a=indexedDB.deleteDatabase(n);a.onsuccess=()=>{h(`üóëÔ∏è Cleared cache: ${n}`),o()},a.onerror=()=>t(a.error),a.onblocked=()=>{console.warn(`‚ö†Ô∏è Cache ${n} is blocked`),o()}})}catch(o){console.warn(`Could not clear ${n}:`,o)}}async function ee(e=3e4){if(window.TransformersJS)return window.TransformersJS;if(window.TransformersJSError)throw window.TransformersJSError;try{const n=await N(()=>import("https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.0.0"),[],import.meta.url),{pipeline:o,env:t}=n;return t.allowLocalModels=!1,t.allowRemoteModels=!0,t.useBrowserCache=!0,window.TransformersJS={pipeline:o,env:t,...n},h("‚úÖ Transformers.js loaded dynamically"),window.TransformersJS}catch(n){throw console.error("‚ùå Failed to load Transformers.js:",n),n}}async function ye(){if(typeof navigator>"u"||!navigator.gpu)return!1;try{return!!await navigator.gpu.requestAdapter()}catch{return!1}}async function te(e=()=>{},n=!1){if(x)return x;try{e({model:"bert",status:"loading",progress:0});const{pipeline:o,env:t}=await ee();return h("üîÑ Loading BERT model (cached in browser)..."),t.allowLocalModels=!1,t.allowRemoteModels=!0,x=await o("token-classification","Xenova/bert-base-NER",{quantized:!0,revision:"main",progress_callback:a=>{if(a.status==="progress"){const s=Math.round(a.progress);h(`üì• BERT: ${s}%`),e({model:"bert",status:"loading",progress:s})}else a.status==="initiate"&&h(`üì¶ Fetching: ${a.file}`)}}),Y.bert="cdn-cached",e({model:"bert",status:"ready",progress:100}),h("‚úÖ BERT loaded (cached in IndexedDB)"),x}catch(o){if(console.error("‚ùå BERT loading failed:",o),o.message?.includes("Unexpected token")&&!n){if(await we(),"caches"in window)try{const t=await caches.keys();for(const a of t)await caches.delete(a);h("üóëÔ∏è Cleared browser caches")}catch(t){console.warn("Could not clear browser cache:",t)}return te(e,!0)}throw e({model:"bert",status:"error",error:o.message}),o}}async function ne(e=()=>{}){if(C)return C;if(!await ye())return console.warn("‚ö†Ô∏è WebGPU not available - Deep Scan disabled"),e({model:"llama",status:"unavailable",progress:0}),$=!1,null;try{e({model:"llama",status:"loading",progress:0});const{CreateMLCEngine:o}=await N(async()=>{const{CreateMLCEngine:t}=await import("./index-D0_3XU6g.js");return{CreateMLCEngine:t}},[],import.meta.url);return C=await o("Llama-3.2-1B-Instruct-q4f16_1-MLC",{initProgressCallback:t=>{const a=typeof t.progress=="number"?Math.round(t.progress*100):0;e({model:"llama",status:"loading",progress:a,text:t.text||"Loading..."})}}),$=!0,e({model:"llama",status:"ready",progress:100}),h("‚úÖ Llama 3.2 model loaded successfully"),C}catch(o){const t=/wasm/i.test(o.message||"")||/404/.test(o.message||"");return $=!1,t?(e({model:"llama",status:"unavailable",error:"Llama WASM not found"}),null):(e({model:"llama",status:"error",error:o.message}),console.error("‚ùå Llama loading failed:",o),null)}}async function he(e=()=>{}){const n={bert:0,llama:0},o=s=>{s.model==="bert"?n.bert=s.progress:s.model==="llama"&&(n.llama=s.progress);const l=s.model==="llama"&&s.status!=="unavailable"?Math.round(n.bert*.3+n.llama*.7):n.bert;e({combined:l,bert:n.bert,llama:n.llama,status:n.bert>=100?"ready":"loading"})},t=await te(o),a=await ne(o);return{bert:t,llama:a}}async function Z(e){if(!x)throw new Error("BERT model not initialized. Call initBert() first.");const n=await x(e,{ignore_labels:[]}),o=[];let t=null;for(const d of n){if(d.score<.5||d.entity==="O")continue;const c=d.entity.replace(/^[BI]-/,""),b=d.entity.startsWith("B-"),p=d.word.replace(/^##/,"");b||!t||t.type!==c?(t&&t.text.length>1&&o.push({text:t.text,score:t.score,type:t.type,source:"bert"}),t={type:c,text:p,score:d.score}):(d.word.startsWith("##")?t.text+=p:t.text+=" "+p,t.score=Math.max(t.score,d.score))}t&&t.text.length>1&&o.push({text:t.text,score:t.score,type:t.type,source:"bert"});const a={emails:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,phones:/\b(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,ssn:/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,creditCards:/\b(?:\d{4}[-\s]?){3}\d{4}\b/g,dates:/\b(?:\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\d{4}[-\/]\d{2}[-\/]\d{2}|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2},?\s+\d{4})\b/gi,addresses:/\b\d{1,5}\s+(?:[A-Za-z]+\s+){1,4}(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Court|Ct|Way|Place|Pl|Circle|Cir)\.?\b/gi,zipCodes:/\b\d{5}(?:-\d{4})?\b/g,ipAddresses:/\b(?:\d{1,3}\.){3}\d{1,3}\b/g,urls:/https?:\/\/[^\s<>"{}|\\^`\[\]]+/g,accountNumbers:/\b(?:acct?\.?|account|id|#)\s*:?\s*[A-Z0-9]{4,20}\b/gi,currency:/\$[\d,]+(?:\.\d{2})?\b|\b\d{1,3}(?:,\d{3})*(?:\.\d{2})?\s*(?:dollars?|USD)\b/gi},s=[];for(const[d,c]of Object.entries(a))(e.match(c)||[]).forEach(p=>{s.push({text:p,score:.95,type:d,source:"regex"})});const i=[/\b(?:Mr\.?|Mrs\.?|Ms\.?|Dr\.?|Prof\.?)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+)+)/g,/\b(?:name|patient|client|customer|employee|applicant|defendant|plaintiff):\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/gi,/\b(?:signed|by|from|to|attn|attention):\s*([A-Z][a-z]+(?:\s+[A-Z][a-z]+)*)/gi];for(const d of i){let c;for(;(c=d.exec(e))!==null;)c[1]&&s.push({text:c[1],score:.85,type:"name",source:"heuristic"})}const l=[...o,...s],m=new Set;return l.filter(d=>{const c=typeof d=="string"?d.trim():d.text.trim();return m.has(c)||c.length<=1||/^[\d\s]+$/.test(c)?!1:(m.add(c),!0)}).map(d=>typeof d=="string"?{text:d,score:.7,type:"unknown",source:"bert"}:d)}async function be(e){if(!C)return console.warn("Llama not available, falling back to BERT"),Z(e);const n=await ve(e),o=`[TASK] Extract ALL personally identifiable information (PII) from the text below.

[CATEGORIES TO FIND]
1. NAMES: Full names, first names, last names, nicknames
2. CONTACT: Phone numbers, email addresses, fax numbers
3. LOCATION: Street addresses, cities, states, ZIP codes, countries
4. IDENTIFIERS: SSN, passport numbers, driver's license, employee IDs, patient IDs, account numbers
5. FINANCIAL: Credit card numbers, bank account numbers, routing numbers, amounts with context
6. DATES: Birth dates, hire dates, appointment dates (not generic dates)
7. MEDICAL: Diagnoses, medications, conditions, treatments
8. OTHER: Any other identifying information

[RULES]
- Extract the EXACT text as it appears
- Include partial matches (e.g., just a first name if that's all there is)
- One item per line
- No explanations or categories, just the raw values
- If nothing found, respond with only: NONE

[TEXT TO ANALYZE]
${e.substring(0,3e3)}

[EXTRACTED PII]`;try{const a=(await C.chat.completions.create({messages:[{role:"user",content:o}],max_tokens:800,temperature:.1,top_p:.9})).choices[0].message.content.trim();if(a==="NONE"||a.toLowerCase().includes("no pii")||a.toLowerCase().includes("no sensitive"))return n;const i=[...a.split(/[\n,]/).map(l=>l.trim()).map(l=>l.replace(/^[-‚Ä¢*\d.)\]]+\s*/,"")).map(l=>l.replace(/^["']|["']$/g,"")).filter(l=>l.length>1&&l!=="NONE"&&!l.toLowerCase().includes("none found")&&!l.toLowerCase().startsWith("no ")&&!/^[a-z\s]+:$/i.test(l)),...n];return[...new Set(i.map(l=>l.trim()).filter(l=>l.length>1))]}catch(t){return console.error("Llama detection failed, falling back to BERT:",t),Z(e)}}function ve(e){const n={emails:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,phones:/\b(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,ssn:/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,creditCards:/\b(?:\d{4}[-\s]?){3}\d{4}\b/g,dates:/\b(?:\d{1,2}[-\/]\d{1,2}[-\/]\d{2,4}|\d{4}[-\/]\d{2}[-\/]\d{2}|(?:Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)[a-z]*\.?\s+\d{1,2},?\s+\d{4})\b/gi,addresses:/\b\d{1,5}\s+(?:[A-Za-z]+\s+){1,4}(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Court|Ct|Way|Place|Pl|Circle|Cir)\.?\b/gi,zipCodes:/\b\d{5}(?:-\d{4})?\b/g,ipAddresses:/\b(?:\d{1,3}\.){3}\d{1,3}\b/g,currency:/\$[\d,]+(?:\.\d{2})?\b/g},o=[];for(const t of Object.values(n)){const a=e.match(t)||[];o.push(...a)}return[...new Set(o.map(t=>t.trim()))]}function q(){return{bert:x!==null,llama:C!==null,llamaAvailable:$,modelTier:D,modelConfig:H[D]}}async function xe(e=()=>{}){if(!(await Q()).canUpgrade)throw new Error("Hardware does not meet requirements for Pro model");const o=H.pro;h(`üöÄ Upgrading to ${o.name}...`);try{e({model:"bert",status:"upgrading",progress:0,tier:"pro"});const{pipeline:t,env:a}=await ee();a.allowLocalModels=!1,a.allowRemoteModels=!0,x=await t("token-classification",o.model,{quantized:o.quantized,revision:"main",progress_callback:i=>{if(i.status==="progress"){const l=Math.round(i.progress);h(`üì• Pro model download: ${l}%`),e({model:"bert",status:"upgrading",progress:l,tier:"pro"})}else i.status==="initiate"&&h(`üì¶ Fetching: ${i.file}`)}}),D="pro",Y.bert="cdn-pro";try{localStorage.setItem("redactor-model-tier","pro")}catch{console.warn("Could not save model preference")}return e({model:"bert",status:"ready",progress:100,tier:"pro"}),h(`‚úÖ Upgraded to ${o.name}`),x}catch(t){throw console.error("‚ùå Pro model upgrade failed:",t),e({model:"bert",status:"error",error:t.message,tier:"pro"}),t}}me.workerSrc="/pdf.worker.min.mjs";async function Ee(e){let n;if(e instanceof File)n=await e.arrayBuffer();else if(e instanceof ArrayBuffer)n=e;else throw new Error("Input must be a File or ArrayBuffer");const o=await X({data:n}).promise,t=[];let a="";for(let s=1;s<=o.numPages;s++){const m=(await(await o.getPage(s)).getTextContent()).items.map(d=>d.str).join(" ").replace(/\s+/g," ").trim();t.push(m),a+=m+`

`}return{text:a.trim(),pageCount:o.numPages,pages:t}}async function Le(e){if(!e||e.type!=="application/pdf")return!1;try{const n=await e.slice(0,5).arrayBuffer(),o=new Uint8Array(n);return String.fromCharCode(...o)==="%PDF-"}catch{return!1}}async function Ce(e,n){const o=new FormData;o.append("file",e),o.append("words",n.join(","));const a=await fetch("/redact",{method:"POST",body:o});if(!a.ok){const s=await a.text();throw new Error(`Redaction failed: ${s}`)}return await a.blob()}function oe(e,n="redacted_secure.pdf"){const o=window.URL.createObjectURL(e),t=document.createElement("a");t.href=o,t.download=n,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(o)}async function Te(e,n={}){const{jsPDF:o}=await N(async()=>{const{jsPDF:s}=await import("./pdf-tools-DOT94L9g.js").then(i=>i.j);return{jsPDF:s}},[],import.meta.url),t=new o;t.setFontSize(18),t.setFont("helvetica","bold"),t.text("Zero-Trust Redaction Report",20,20),t.setFontSize(10),t.setFont("helvetica","normal"),t.text(`Generated: ${new Date().toLocaleString()}`,20,30),n.filename&&t.text(`Original File: ${n.filename}`,20,38),t.setDrawColor(16,185,129),t.line(20,45,190,45),t.setFontSize(14),t.setFont("helvetica","bold"),t.text("Detected Sensitive Items:",20,55),t.setFontSize(11),t.setFont("courier","normal");let a=65;return e.forEach((s,i)=>{a>270&&(t.addPage(),a=20),t.text(`${i+1}. ${s}`,25,a),a+=8}),t.setFontSize(8),t.setFont("helvetica","italic"),t.text("Processed locally - No data uploaded to cloud",20,285),t.output("blob")}const ae={"bank-statement":{name:"Bank Statement",icon:"üè¶",description:"Account numbers, routing numbers, balances, transactions",patterns:[/\b\d{8,17}\b/g,/\b\d{3}[-\s]?\d{3}[-\s]?\d{3}\b/g,/\b\d{9}\b/g,/\b[A-Z]{4}[A-Z]{2}[A-Z0-9]{2}([A-Z0-9]{3})?\b/g,/\b[A-Z]{2}\d{2}[A-Z0-9]{4,30}\b/g,/\b(?:\d{4}[-\s]?){3}\d{4}\b/g,/\b\d{15,16}\b/g,/\$[\d,]+\.?\d*/g,/¬£[\d,]+\.?\d*/g,/‚Ç¨[\d,]+\.?\d*/g],keywords:["account number","routing number","swift","iban","balance","available balance","current balance","account holder","card number","debit","credit","transaction","wire transfer","beneficiary","remitter","sort code","bsb","branch"],contextClues:["statement period","account summary","transaction history","opening balance","closing balance","total credits","total debits"]},"medical-record":{name:"Medical Record",icon:"üè•",description:"Patient IDs, diagnoses, medications, provider info",patterns:[/\b[A-Z]?\d{6,10}\b/g,/\b\d{10}\b/g,/\b[A-Z]{2}\d{7}\b/g,/\b[A-Z]\d{2}\.?\d{0,2}\b/g,/\b\d{5}\b/g,/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g,/\b\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g],keywords:["patient","dob","date of birth","mrn","medical record","diagnosis","medication","prescription","dosage","physician","provider","npi","insurance","policy number","member id","blood type","allergies","condition","treatment","procedure","ssn","social security","medicare","medicaid","hipaa"],contextClues:["chief complaint","history of present illness","physical exam","assessment","plan","discharge summary","lab results"]},"legal-document":{name:"Legal Document",icon:"‚öñÔ∏è",description:"Case numbers, party names, addresses, sensitive clauses",patterns:[/\b\d{1,4}[-:]\w{2,4}[-:]\d{4,8}\b/g,/\bCase\s*(?:No\.?|#)\s*[\w\-]+/gi,/\bBar\s*(?:No\.?|#)\s*\d+/gi,/\bDocket\s*(?:No\.?|#)\s*[\w\-]+/gi,/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g,/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Court|Ct)\.?/gi,/\b\d{5}(?:-\d{4})?\b/g],keywords:["plaintiff","defendant","petitioner","respondent","attorney","counsel","witness","testimony","affidavit","deposition","settlement","judgment","verdict","liability","damages","confidential","privileged","sealed","exhibit","evidence"],contextClues:["court of","in the matter of","hereby","whereas","jurisdiction","stipulation","motion","order","brief","memorandum"]},employment:{name:"Employment / HR",icon:"üëî",description:"Employee IDs, salaries, SSN, performance data",patterns:[/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,/\b[A-Z]{1,3}\d{4,8}\b/g,/\bEMP[-\s]?\d+/gi,/\$[\d,]+(?:\.\d{2})?(?:\s*(?:\/\s*(?:year|yr|month|mo|hour|hr|week|wk)))?/gi,/\b\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g],keywords:["employee","employer","salary","compensation","bonus","ssn","social security","tax id","ein","w2","w4","i9","direct deposit","bank account","performance","review","termination","hire date","manager","supervisor","department","title","position"],contextClues:["human resources","payroll","benefits","employment agreement","offer letter","termination letter","performance review"]},identity:{name:"Identity Documents",icon:"ü™™",description:"Passports, driver licenses, ID cards, personal info",patterns:[/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,/\b[A-Z]{1,2}\d{6,9}\b/g,/\b[A-Z]\d{7,8}\b/g,/\b\d{1,3}[-\s]?\d{3}[-\s]?\d{3}[-\s]?\d{3,4}\b/g,/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g,/\d+\s+[\w\s]+(?:Street|St|Avenue|Ave|Road|Rd|Boulevard|Blvd|Drive|Dr|Lane|Ln|Court|Ct)\.?/gi],keywords:["passport","driver license","drivers license","id card","ssn","social security","date of birth","dob","place of birth","pob","nationality","citizenship","address","residence","expiry","issue date","issuing authority","sex","gender","height","weight"],contextClues:["identification","verified","photo id","government issued"]},financial:{name:"Financial / Tax",icon:"üí∞",description:"Tax returns, investments, income, financial accounts",patterns:[/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,/\b\d{2}[-\s]?\d{7}\b/g,/\b\d{8,17}\b/g,/\$[\d,]+\.?\d*/g,/\b1099[-\s]?[A-Z]{1,4}\b/gi,/\bW[-\s]?[249]\b/gi],keywords:["income","tax","gross","net","deduction","exemption","refund","agi","adjusted gross","taxable","withholding","fica","medicare","investment","dividend","capital gain","interest","portfolio","brokerage","retirement","401k","ira","roth","pension"],contextClues:["tax return","form 1040","schedule","irs","internal revenue","fiscal year","tax year","quarterly","annual report"]},insurance:{name:"Insurance",icon:"üõ°Ô∏è",description:"Policy numbers, claims, coverage details",patterns:[/\b[A-Z]{2,4}[-\s]?\d{6,12}\b/g,/\b(?:CLM|CLAIM)[-\s]?\d+/gi,/\b(?:GRP|GROUP)[-\s]?\d+/gi,/\b(?:MEM|MEMBER)[-\s]?\d+/gi,/\b\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}\b/g,/\$[\d,]+\.?\d*/g],keywords:["policy","policyholder","insured","beneficiary","premium","deductible","copay","coverage","claim","claimant","adjuster","liability","exclusion","rider","endorsement","effective date","expiration","renewal","underwriting","actuarial"],contextClues:["certificate of insurance","proof of insurance","declarations page","policy schedule","coverage summary"]},custom:{name:"Custom Keywords",icon:"‚úèÔ∏è",description:"Your own keywords and patterns",patterns:[],keywords:[],contextClues:[]}},Ie={email:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,phone:/\b(?:\+?1[-.\s]?)?\(?\d{3}\)?[-.\s]?\d{3}[-.\s]?\d{4}\b/g,ssn:/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,date:/\b(?:\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4}|\d{4}[\/\-]\d{2}[\/\-]\d{2})\b/g,ipv4:/\b(?:\d{1,3}\.){3}\d{1,3}\b/g,creditCard:/\b(?:\d{4}[-\s]?){3}\d{4}\b/g,zipCode:/\b\d{5}(?:-\d{4})?\b/g,url:/https?:\/\/[^\s<>"']+/g,currency:/\$[\d,]+(?:\.\d{2})?\b/g,accountNum:/\b(?:account|acct\.?|acc)\s*#?\s*:?\s*([A-Z0-9]{4,20})\b/gi},Se={titled:/\b(?:Mr\.?|Mrs\.?|Ms\.?|Miss|Dr\.?|Prof\.?|Rev\.?)\s+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,2})\b/g,labeled:/\b(?:name|patient|client|customer|employee|applicant|defendant|plaintiff|author|contact|attn|attention|from|to|by|signed)[\s:]+([A-Z][a-z]+(?:\s+[A-Z][a-z]+){0,3})\b/gi,lastFirst:/\b([A-Z][a-z]+),\s+([A-Z][a-z]+(?:\s+[A-Z]\.?)?)\b/g,standalone:/\b([A-Z][a-z]{2,15}\s+[A-Z][a-z]{2,15}(?:\s+[A-Z][a-z]{2,15})?)\b/g};function Be(e,n=[],o=[]){const t=new Set,a=e.toLowerCase();return Object.values(Ie).forEach(s=>{s.lastIndex=0,(e.match(s)||[]).forEach(l=>t.add(l.trim()))}),Object.values(Se).forEach(s=>{s.lastIndex=0;let i;for(;(i=s.exec(e))!==null;){const l=i[1]||i[0];l&&l.length>3&&!J(l)&&t.add(l.trim())}}),n.forEach(s=>{const i=ae[s];i&&(i.patterns.forEach(l=>{l.global&&(l.lastIndex=0),(e.match(l)||[]).forEach(d=>{d.length>=3&&t.add(d.trim())})}),i.keywords.forEach(l=>{const m=l.toLowerCase();let d=a.indexOf(m);for(;d!==-1;){const b=e.substring(d,d+100).match(/^[^:=\n]*[:=]?\s*([^\n,;]{2,50})/);if(b&&b[1]){const p=b[1].trim();p.length>2&&p.toLowerCase()!==m&&!J(p)&&t.add(p)}d=a.indexOf(m,d+1)}}))}),o.forEach(s=>{if(s.trim()&&a.includes(s.toLowerCase())){let i=a.indexOf(s.toLowerCase());for(;i!==-1;)t.add(e.substring(i,i+s.length)),i=a.indexOf(s.toLowerCase(),i+1)}}),Array.from(t).filter(s=>s.trim().length>=2)}function J(e){return["the","a","an","is","are","was","were","and","or","but","for","with","this","that","from","have","has","had","will","would","could","should","may","might","must","can","not","all","any","each","every","both","few","more","most","other","some","such","than","too","very","just","only","also","even","still","yet","account","number","date","name","address","phone","email","statement","record","document","page","total","amount","balance","january","february","march","april","may","june","july","august","september","october","november","december","monday","tuesday","wednesday","thursday","friday","saturday","sunday"].includes(e.toLowerCase().trim())}function Ae(){return Object.entries(ae).map(([e,n])=>({id:e,name:n.name,icon:n.icon,description:n.description}))}function Pe(){try{const e=localStorage.getItem("redactor-custom-keywords");return e?JSON.parse(e):[]}catch{return[]}}function Me(){try{const e=localStorage.getItem("redactor-active-presets");return e?JSON.parse(e):[]}catch{return[]}}function Re(e){localStorage.setItem("redactor-active-presets",JSON.stringify(e))}let z="fast",M="auto",L=null,f=[],g=[],K=Pe(),R=Me(),v={scanned:0,entities:0,redacted:0};const r={loadingOverlay:document.getElementById("loading-overlay"),loadingFill:document.getElementById("loading-fill"),loadingText:document.getElementById("loading-text"),stepBert:document.getElementById("step-bert"),stepLlama:document.getElementById("step-llama"),stepReady:document.getElementById("step-ready"),appContainer:document.getElementById("app-container"),statusCard:document.getElementById("status-card"),statusDot:document.getElementById("status-dot"),statusText:document.getElementById("status-text"),statusDetail:document.getElementById("status-detail"),statScanned:document.getElementById("stat-scanned"),statEntities:document.getElementById("stat-entities"),statRedacted:document.getElementById("stat-redacted"),dropZone:document.getElementById("drop-zone"),fileUpload:document.getElementById("file-upload"),fileInfo:document.getElementById("file-info"),inputText:document.getElementById("input-text"),outputArea:document.getElementById("output-area"),entitiesList:document.getElementById("entities-list"),entityCount:document.getElementById("entity-count"),pdfViewerContainer:document.getElementById("pdf-viewer-container"),textViewContainer:document.getElementById("text-view-container"),pdfViewport:document.getElementById("pdf-viewport"),pdfPages:document.getElementById("pdf-pages"),pdfZoomLevel:document.getElementById("pdf-zoom-level"),pdfPageInfo:document.getElementById("pdf-page-info"),viewToggle:document.getElementById("view-toggle"),btnScan:document.getElementById("btn-scan"),btnRedact:document.getElementById("btn-redact"),btnReport:document.getElementById("btn-report"),modeOptions:document.querySelectorAll(".mode-option"),toastContainer:document.getElementById("toast-container"),selectionTooltip:document.getElementById("selection-tooltip"),textOverlay:document.getElementById("text-overlay")};let w=null,I=1,P="pdf";const T=(...e)=>{};function se(){document.addEventListener("keydown",e=>{if((e.ctrlKey||e.metaKey)&&e.key==="s"&&(e.preventDefault(),L&&!r.btnScan?.disabled&&window.runScan()),(e.ctrlKey||e.metaKey)&&e.key==="r"&&(e.preventDefault(),L&&!r.btnRedact?.disabled&&window.runRedaction()),(e.ctrlKey||e.metaKey)&&e.key==="p"&&(e.preventDefault(),(f.length>0||g.length>0)&&window.showPreviewModal()),e.key==="Escape"&&(r.selectionTooltip?.classList.add("hidden"),document.getElementById("preview-modal")?.classList.add("hidden")),(e.ctrlKey||e.metaKey)&&e.key==="z"&&!e.shiftKey&&g.length>0){e.preventDefault();const n=g.pop();k(),P==="pdf"&&w&&S(),u("info","Undone",`Removed "${n.substring(0,20)}..."`)}})}async function V(){se(),y("bert","active");try{const e=await he(o=>{r.loadingFill&&(r.loadingFill.style.width=`${o.combined}%`),r.loadingText&&(r.loadingText.textContent=`Initializing Privacy Engine... ${o.combined}%`),o.bert>=100&&(y("bert","complete"),y("llama","active")),o.llama>=100&&y("llama","complete")}),n=q();if(Fe(),Ne(),n.llama)y("llama","complete"),y("ready","complete"),await U(500),_(),E("ready","System Secure","All AI models loaded"),u("success","Ready","BERT + Llama models loaded");else{y("llama","error"),y("ready","complete"),await U(500),_(),E("partial","Fast Mode Only","WebGPU not available for Deep Scan"),u("warning","Limited Mode","Deep Scan unavailable - using Fast Mode");const o=document.querySelector('.mode-option[data-mode="deep"]');o&&(o.classList.add("disabled"),o.title="Requires WebGPU support")}r.btnRedact.disabled=!1}catch(e){console.error("Initialization failed:",e),y("bert","error"),y("llama","error"),r.loadingText&&(r.loadingText.innerHTML=`
        <span style="color: #ef4444;">Failed to load AI models</span><br>
        <small style="color: #a1a1aa;">${e.message}</small><br><br>
        <button onclick="window.retryInit()" style="padding: 8px 16px; background: var(--accent); color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">
          üîÑ Retry
        </button>
        <button onclick="window.downloadModels()" style="padding: 8px 16px; background: #16a34a; color: white; border: none; border-radius: 6px; cursor: pointer; margin-right: 8px;">
          ‚¨áÔ∏è Download BERT (50MB)
        </button>
        <button onclick="window.useOfflineMode()" style="padding: 8px 16px; background: #374151; color: white; border: none; border-radius: 6px; cursor: pointer;">
          üì¥ Use Offline Mode (Patterns Only)
        </button>
      `)}}window.retryInit=async function(){r.loadingText&&(r.loadingText.textContent="Retrying..."),r.loadingFill&&(r.loadingFill.style.width="0%"),y("bert","active"),y("llama",""),y("ready",""),await V()};window.downloadModels=async function(){try{E("loading","Downloading models","Fetching BERT locally...");const e=await fetch("/api/download-models",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:"bert"})}),n=await e.json();if(!e.ok)throw new Error(n?.error||"Download failed");u("success","Models downloaded","BERT model cached locally. Initializing..."),await U(300),await V()}catch(e){u("error","Download failed",e.message||"Unable to download models"),E("error","Download failed",e.message||"Check your connection")}};window.useOfflineMode=function(){_(),E("partial","Offline Mode","Using pattern-based detection only"),u("warning","Offline Mode","AI disabled. Using Intel Database patterns only.");const e=document.querySelector('.mode-option[data-mode="deep"]');e&&(e.classList.add("disabled"),e.title="AI models not loaded"),window.offlineMode=!0};function y(e,n){const o=r[`step${e.charAt(0).toUpperCase()+e.slice(1)}`];o&&(o.classList.remove("active","complete","error"),n&&o.classList.add(n))}function _(){r.loadingOverlay?.classList.add("hidden"),r.appContainer?.classList.add("visible")}function U(e){return new Promise(n=>setTimeout(n,e))}function E(e,n,o){const{statusCard:t,statusDot:a,statusText:s,statusDetail:i}=r;t?.classList.remove("ready","error","partial"),a?.classList.remove("ready","error"),e==="ready"?(t?.classList.add("ready"),a?.classList.add("ready")):e==="error"&&(t?.classList.add("error"),a?.classList.add("error")),s&&(s.textContent=n),i&&(i.textContent=o)}function A(){r.statScanned&&(r.statScanned.textContent=v.scanned),r.statEntities&&(r.statEntities.textContent=v.entities),r.statRedacted&&(r.statRedacted.textContent=v.redacted)}function re(){const e=f.length+g.length;r.entityCount&&(r.entityCount.textContent=e),v.entities=e,A()}function u(e,n,o,t=4e3){const a=r.toastContainer;if(!a)return;const s=document.createElement("div");s.className=`toast ${e}`;const i={success:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>',error:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>',warning:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>',info:'<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'};s.innerHTML=`
    <div class="toast-icon">${i[e]||i.info}</div>
    <div class="toast-content">
      <div class="toast-title">${n}</div>
      <div class="toast-message">${o}</div>
    </div>
    <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
  `,a.appendChild(s),setTimeout(()=>{s.classList.add("removing"),setTimeout(()=>s.remove(),300)},t)}window.setMode=async function(e,n){if(z=e,r.modeOptions.forEach(o=>o.classList.remove("active")),n.classList.add("active"),e==="deep"&&!q().llama){E("loading","Loading Deep Scan...","Downloading Llama 3 model"),r.btnRedact.disabled=!0;try{await ne(t=>{E("loading","Loading Deep Scan...",`${t.progress}% complete`)}),E("ready","System Secure","Deep scan ready"),r.btnRedact.disabled=!1,u("success","Deep Scan Ready","Llama 3 model loaded successfully")}catch{E("partial","Fast Mode Only","Deep scan unavailable"),z="fast",document.querySelector('.mode-option[data-mode="fast"]')?.classList.add("active"),n.classList.remove("active"),u("error","Load Failed","Could not load Llama 3 model")}}};window.setDocumentType=function(e){M=e;const n=document.getElementById("doc-type-info");if(n)if(e==="auto")n.classList.remove("active"),n.querySelector(".info-text").textContent="Improves detection accuracy";else{n.classList.add("active");const o=Ae()[e],t=o?.patterns?.length||0,a=o?.keywords?.length||0;n.querySelector(".info-text").textContent=`+${t} patterns, +${a} keywords`}};function De(){const{dropZone:e,fileUpload:n,inputText:o}=r;n?.addEventListener("change",Oe),document.querySelector(".browse-link")?.addEventListener("click",()=>n?.click()),e?.addEventListener("click",s=>{(s.target.closest(".browse-link")||s.target===e||s.target.closest(".drop-content"))&&n?.click()}),e?.addEventListener("dragover",s=>{s.preventDefault(),e.classList.add("drag-over")}),e?.addEventListener("dragleave",s=>{s.preventDefault(),e.classList.remove("drag-over")}),e?.addEventListener("drop",async s=>{s.preventDefault(),e.classList.remove("drag-over");const i=s.dataTransfer.files[0];i&&await ie(i)}),o?.addEventListener("mouseup",G),o?.addEventListener("keyup",s=>{(s.shiftKey||s.key==="Shift")&&G()});let a=null;document.addEventListener("mouseup",s=>{(s.target.closest(".pdf-text-layer")||s.target.closest("#pdf-pages"))&&(a&&clearTimeout(a),a=setTimeout(()=>{const i=window.getSelection();if(!i||i.rangeCount===0)return;const l=i.toString().trim();if(l&&l.length>1)try{const d=i.getRangeAt(0).commonAncestorContainer,c=d.nodeType===3?d.parentElement:d;c&&(c.closest(".pdf-text-layer")||c.closest("#pdf-pages"))&&ce(l,i,"pdf")}catch(m){console.warn("Selection validation error:",m)}},50))}),o?.addEventListener("scroll",()=>{r.selectionTooltip?.classList.add("hidden"),r.textOverlay&&(r.textOverlay.scrollTop=o.scrollTop,r.textOverlay.scrollLeft=o.scrollLeft)}),document.addEventListener("mousedown",s=>{!s.target.closest(".selection-tooltip")&&!s.target.closest(".pdf-text-layer")&&!s.target.closest("#input-text")&&!s.target.closest(".textarea-wrapper")&&r.selectionTooltip?.classList.add("hidden")})}async function Oe(e){const n=e.target.files[0];n&&await ie(n)}async function ie(e){const{inputText:n,fileInfo:o,dropZone:t}=r;if(o.innerHTML=`
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
      <polyline points="14 2 14 8 20 8"/>
    </svg>
    <span>${e.name}</span>
  `,o.classList.add("has-file"),t?.classList.add("has-file"),e.type==="application/pdf"){if(!await Le(e)){u("error","Invalid File","The file does not appear to be a valid PDF");return}u("info","Processing","Loading PDF..."),L=e;try{const{text:a,pageCount:s}=await Ee(e);n.value=a,await ke(e),switchView("pdf"),v.scanned++,A(),u("success","PDF Loaded",`${s} page${s>1?"s":""} ready for review`)}catch(a){u("error","Read Error",a.message),console.error(a)}}else{L=e,w=null;const a=await e.text();n.value=a,switchView("text"),v.scanned++,A(),u("success","File Loaded","Text file loaded successfully")}}async function ke(e){const n=await e.arrayBuffer();w=await X({data:n}).promise;const o=r.pdfPages;o.innerHTML="";for(let t=1;t<=w.numPages;t++)await de(t);le()}async function de(e){const n=await w.getPage(e),o=I*1.5,t=n.getViewport({scale:o}),a=document.createElement("div");a.className="pdf-page-wrapper",a.dataset.page=e;const s=document.createElement("canvas"),i=s.getContext("2d");s.width=t.width,s.height=t.height,await n.render({canvasContext:i,viewport:t}).promise,a.appendChild(s);const l=document.createElement("div");l.className="pdf-text-layer",l.style.width=`${t.width}px`,l.style.height=`${t.height}px`,(await n.getTextContent()).items.forEach(d=>{const c=document.createElement("span");c.textContent=d.str;const b=pe.transform(t.transform,d.transform);c.style.left=`${b[4]}px`,c.style.top=`${b[5]-d.height*o}px`,c.style.fontSize=`${d.height*o}px`,c.style.fontFamily=d.fontName||"sans-serif";const p=d.str.trim();p.length>2&&(g.some(B=>p.includes(B)||B.includes(p))?c.classList.add("highlight-manual"):f.some(B=>{const W=typeof B=="object"?B.text:B;return p.includes(W)||W.includes(p)})&&c.classList.add("highlight-entity")),l.appendChild(c)}),a.appendChild(l),r.pdfPages.appendChild(a)}async function S(){if(!w)return;const e=r.pdfPages;e.innerHTML="";for(let n=1;n<=w.numPages;n++)await de(n);le()}function le(){w&&(r.pdfPageInfo&&(r.pdfPageInfo.textContent=`${w.numPages} page${w.numPages>1?"s":""}`),r.pdfZoomLevel&&(r.pdfZoomLevel.textContent=`${Math.round(I*100)}%`))}window.switchView=function(e){P=e;const n=r.pdfViewerContainer,o=r.textViewContainer;document.querySelectorAll(".view-btn").forEach(a=>{a.classList.toggle("active",a.dataset.view===e)}),e==="pdf"?(n?.classList.remove("hidden"),o?.classList.add("hidden"),w&&(f.length>0||g.length>0)&&S()):(n?.classList.add("hidden"),o?.classList.remove("hidden"),ue())};window.pdfZoomIn=function(){I<3&&(I+=.25,S())};window.pdfZoomOut=function(){I>.5&&(I-=.25,S())};window.pdfPrevPage=function(){const e=r.pdfViewport;e&&e.scrollBy({top:-e.clientHeight,behavior:"smooth"})};window.pdfNextPage=function(){const e=r.pdfViewport;e&&e.scrollBy({top:e.clientHeight,behavior:"smooth"})};function G(e){let n="",o=null;const t=r.inputText;if(t&&document.activeElement===t){const a=t.selectionStart,s=t.selectionEnd;a!==s&&(n=t.value.substring(a,s).trim(),o="textarea")}else n=window.getSelection()?.toString().trim()||"",o="window";n&&n.length>1?ce(n,o==="textarea"?null:window.getSelection(),o):r.selectionTooltip?.classList.add("hidden")}function ce(e,n,o="window"){const t=r.selectionTooltip;if(t)try{let a;if(o==="textarea"){const d=r.inputText;if(!d)return;const c=d.getBoundingClientRect();a={left:c.left+c.width/2,right:c.left+c.width/2+100,top:c.top+100,bottom:c.top+120,width:100,height:20}}else if(a=n.getRangeAt(0).getBoundingClientRect(),a.width===0&&a.height===0)return;t.querySelector(".tooltip-text").textContent=`"${e.substring(0,25)}${e.length>25?"...":""}"`;const s=t.querySelector(".tooltip-add");s.onclick=()=>{$e(e),t.classList.add("hidden"),o!=="textarea"&&window.getSelection().removeAllRanges()},t.classList.remove("hidden");let i=a.left+a.width/2-100,l=a.bottom+8;const m=220;i<10&&(i=10),i+m>window.innerWidth-10&&(i=window.innerWidth-m-10),l+60>window.innerHeight&&(l=a.top-50),t.style.left=`${i}px`,t.style.top=`${l}px`}catch(a){console.warn("Could not position tooltip:",a)}}function $e(e){g.includes(e)||(g.push(e),k(),P==="pdf"&&w&&S(),u("success","Target Added",`"${e.substring(0,20)}..." added to targets`))}window.removeEntity=function(e,n){n==="auto"?f.splice(e,1):g.splice(e,1),k(),re(),P==="pdf"&&w&&S()};function ue(){const e=r.textOverlay,n=r.inputText;if(!e||!n)return;const o=n.value;if(!o){e.innerHTML="";return}const t=[...f.map(s=>({text:typeof s=="object"?s.text:s,type:"auto"})),...g.map(s=>({text:s,type:"manual"}))];if(t.length===0){e.innerHTML="";return}let a=O(o);t.sort((s,i)=>i.text.length-s.text.length),t.forEach(s=>{const i=O(s.text),l=new RegExp(j(i),"gi"),m=s.type==="manual"?"text-highlight-manual":"text-highlight-auto";a=a.replace(l,`<mark class="${m}">${i}</mark>`)}),a=a.replace(/\n/g,"<br>"),e.innerHTML=a,e.scrollTop=n.scrollTop,e.scrollLeft=n.scrollLeft}function O(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}function j(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function k(){const e=r.entitiesList;if(!e)return;const n=[...f.map((o,t)=>{const a=typeof o=="object";return{text:a?o.text:o,score:a?o.score:null,source:a?o.source:"ai",entityType:a?o.type:"unknown",type:"auto",index:t}}),...g.map((o,t)=>({text:o,type:"manual",score:1,source:"manual",index:t}))];if(re(),n.length===0){e.innerHTML=`
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="11" cy="11" r="8"/>
          <line x1="21" y1="21" x2="16.65" y2="16.65"/>
        </svg>
        <p>No targets detected yet</p>
        <small>Upload a document and run scan</small>
      </div>
    `;return}n.sort((o,t)=>(t.score||0)-(o.score||0)),e.innerHTML=n.map(({text:o,type:t,index:a,score:s,source:i,entityType:l})=>{const m=s>=.9?"high":s>=.7?"medium":"low",d=s?Math.round(s*100):"‚Äî",c=i==="bert"?"ü§ñ":i==="regex"?"üîç":i==="heuristic"?"üìù":i==="manual"?"‚úã":"üìã";return`
      <div class="entity-item">
        <div class="entity-main">
          <span class="entity-text">${O(o)}</span>
          <div class="entity-meta">
            <span class="entity-tag ${t}">${t==="auto"?l||"AI":"Manual"}</span>
            ${s?`<span class="confidence-badge ${m}" title="Confidence: ${d}%">${d}%</span>`:""}
            <span class="source-icon" title="Source: ${i}">${c}</span>
          </div>
        </div>
        <button class="entity-remove" onclick="removeEntity(${a}, '${t}')" title="Remove">√ó</button>
      </div>
    `}).join(""),ue()}window.runScan=async function(){const e=r.inputText?.value;if(!e?.trim()){u("warning","No Content","Please upload a document or paste text first");return}const n=r.btnScan,o=n.innerHTML;n.innerHTML=`
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="spin">
      <circle cx="12" cy="12" r="10"/>
      <path d="M12 6v6l4 2"/>
    </svg>
    <span>Scanning...</span>
  `,n.disabled=!0;try{let t=R;M&&M!=="auto"&&(t=[M],T(`üìã Using document type: ${M}`));let a=[];if((t.length>0||K.length>0)&&(u("info","Intel Scan","Applying pattern-based detection..."),a=Be(e,t,K),T(`üìã Intel Database found ${a.length} matches`)),window.offlineMode)f=a.map(s=>({text:s,score:.9,type:"pattern",source:"intel"}));else{let s=[];z==="fast"?s=await Z(e):s=await be(e),T(`ü§ñ AI found ${s.length} matches`);const i=a.map(d=>({text:d,score:.9,type:"pattern",source:"intel"})),l=new Set;f=[...s,...i].filter(d=>{const c=typeof d=="string"?d:d.text;return l.has(c)?!1:(l.add(c),!0)})}if(k(),P==="pdf"&&w&&S(),f.length===0)u("success","Scan Complete","No sensitive data detected");else{const s=f.filter(m=>m.source!=="intel").length,i=f.filter(m=>m.source==="intel").length;let l=`Found ${f.length} targets`;i>0&&(l+=` (${s} AI, ${i} pattern)`),u("success","Scan Complete",l),r.btnRedact.disabled=!1}}catch(t){u("error","Scan Failed",t.message),console.error(t)}finally{n.innerHTML=o,n.disabled=!1}};window.runRedaction=async function(){const e=f.map(t=>typeof t=="object"?t.text:t),n=[...new Set([...e,...g])];if(!L){u("warning","No File","Please upload a PDF file first");return}if(n.length===0){u("warning","No Targets","Run a scan first to detect sensitive data");return}const o=r.btnRedact;o.classList.add("processing"),o.disabled=!0;try{u("info","Processing","Applying redactions to PDF...");const t=await Ce(L,n),a=new Date().toISOString().slice(0,10);oe(t,`redacted_${a}.pdf`),v.redacted+=n.length,A(),u("success","Complete!",`Redacted ${n.length} items. PDF downloaded.`)}catch(t){u("error","Redaction Failed",t.message),console.error(t)}finally{o.classList.remove("processing"),o.disabled=!1}};window.generateRedactionReport=async function(){const e=[...f,...g];if(e.length===0){u("warning","No Data","Run a scan first to generate a report");return}try{const n=e.map(t=>typeof t=="object"?t.text:t),o=await Te(n,{filename:L?.name||"Unknown"});oe(o,`redaction_report_${new Date().toISOString().slice(0,10)}.pdf`),u("success","Report Generated","Detection report downloaded")}catch(n){u("error","Report Failed",n.message)}};window.showPreviewModal=function(){const e=[...f,...g];if(e.length===0){u("warning","No Targets","Run a scan first to preview");return}const n=r.inputText?.value||"";if(!n){u("warning","No Content","Upload a document first");return}const o=e.map(d=>typeof d=="object"?d.text:d);let t=O(n),a=n;[...o].sort((d,c)=>c.length-d.length).forEach(d=>{const c=O(d),b=new RegExp(j(c),"gi");t=t.replace(b,`<mark class="highlight-preview">${c}</mark>`);const p=new RegExp(j(d),"gi");a=a.replace(p,"‚ñà".repeat(Math.min(d.length,20)))});const i=document.getElementById("preview-original"),l=document.getElementById("preview-redacted"),m=document.getElementById("preview-count");i&&(i.innerHTML=t.substring(0,5e3)+(n.length>5e3?"...":"")),l&&(l.textContent=a.substring(0,5e3)+(n.length>5e3?"...":"")),m&&(m.textContent=o.length),document.getElementById("preview-modal")?.classList.remove("hidden")};window.closePreviewModal=function(){document.getElementById("preview-modal")?.classList.add("hidden")};window.clearAll=function(){L=null,f=[],g=[],w=null,v.scanned=0,v.entities=0,v.redacted=0,A(),r.inputText&&(r.inputText.value="");const e=document.getElementById("file-upload");e&&(e.value=""),r.fileInfo&&(r.fileInfo.innerHTML=`
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
        <polyline points="14 2 14 8 20 8"/>
      </svg>
      <span>No file selected</span>
    `,r.fileInfo.classList.remove("has-file")),r.dropZone?.classList.remove("has-file"),r.pdfPages&&(r.pdfPages.innerHTML=""),r.pdfPageInfo&&(r.pdfPageInfo.textContent=""),r.pdfZoomLevel&&(r.pdfZoomLevel.textContent="100%"),I=1,P="text",r.viewToggle&&r.viewToggle.querySelectorAll(".view-btn").forEach(n=>{n.classList.toggle("active",n.dataset.view==="text")}),r.pdfViewerContainer&&r.pdfViewerContainer.classList.add("hidden"),r.textViewContainer&&r.textViewContainer.classList.remove("hidden"),r.selectionTooltip?.classList.add("hidden"),r.textOverlay&&(r.textOverlay.innerHTML=""),k(),u("info","Cleared","All data has been cleared")};window.togglePreset=function(e,n){const o=R.indexOf(e);o===-1?(R.push(e),n.classList.add("active"),u("success","Preset Enabled",`${n.querySelector(".preset-name").textContent} patterns activated`)):(R.splice(o,1),n.classList.remove("active"),u("info","Preset Disabled",`${n.querySelector(".preset-name").textContent} patterns deactivated`)),Re(R)};function Fe(){const e=q(),n=document.getElementById("bert-status-dot"),o=document.getElementById("llama-status-dot"),t=document.getElementById("bert-model-desc");n&&(n.classList.remove("ready","loading","error"),n.classList.add(e.bert?"ready":"error"),n.title=e.bert?"Ready":"Not loaded"),o&&(o.classList.remove("ready","loading","error"),o.classList.add(e.llama?"ready":"error"),o.title=e.llama?"Ready":"Not available (requires WebGPU)"),t&&e.modelConfig&&(t.textContent=e.modelConfig.description)}async function Ne(){try{const e=await ge(),n=fe(),o=document.getElementById("model-upgrade-option"),t=document.getElementById("btn-upgrade-model"),a=document.getElementById("upgrade-btn-text");if(!o)return;if(n.tier==="pro"){o.classList.add("hidden");return}e?(o.classList.remove("hidden"),T("üñ•Ô∏è High-performance hardware detected - Pro model available")):(o.classList.add("hidden"),T("‚ÑπÔ∏è Standard hardware - using optimized model"))}catch(e){console.warn("Could not check hardware:",e)}}window.upgradeModel=async function(){const e=document.getElementById("btn-upgrade-model"),n=document.getElementById("upgrade-btn-text"),o=document.getElementById("model-upgrade-option"),t=document.getElementById("bert-model-desc");if(e)try{e.disabled=!0,e.classList.add("downloading"),n.textContent="Downloading...",u("info","Upgrading Model","Downloading enhanced BERT model..."),await xe(a=>{a.status==="upgrading"&&(n.textContent=`${a.progress}%`)}),e.classList.remove("downloading"),e.classList.add("active"),n.textContent="Active",t&&(t.textContent="Enhanced Accuracy"),u("success","Model Upgraded","Now using BERT Large NER for enhanced detection"),setTimeout(()=>{o&&(o.style.opacity="0",setTimeout(()=>o.classList.add("hidden"),300))},2e3)}catch(a){e.disabled=!1,e.classList.remove("downloading"),n.textContent="Retry",u("error","Upgrade Failed",a.message)}};window.scrollToTop=function(){window.scrollTo({top:0,behavior:"smooth"})};function Ze(){const e=document.getElementById("scroll-to-top");e&&window.addEventListener("scroll",()=>{window.scrollY>300?e.classList.remove("hidden"):e.classList.add("hidden")})}window.showPrivacyPolicy=function(){const e=document.getElementById("privacy-modal");e&&(e.classList.remove("hidden"),T("üìã Privacy policy viewed:",new Date().toISOString()))};window.closePrivacyPolicy=function(){const e=document.getElementById("privacy-modal");e&&e.classList.add("hidden")};window.showTermsOfService=function(){const e=document.getElementById("terms-modal");e&&(e.classList.remove("hidden"),T("üìã Terms of service viewed:",new Date().toISOString()))};window.closeTermsOfService=function(){const e=document.getElementById("terms-modal");e&&e.classList.add("hidden")};document.addEventListener("click",e=>{const n=document.getElementById("privacy-modal"),o=document.getElementById("terms-modal");e.target===n&&window.closePrivacyPolicy(),e.target===o&&window.closeTermsOfService()});document.addEventListener("keydown",e=>{e.key==="Escape"&&(window.closePrivacyPolicy(),window.closeTermsOfService())});document.addEventListener("DOMContentLoaded",()=>{De(),se(),Ze(),A(),V()});
